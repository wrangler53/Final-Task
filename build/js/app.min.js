"use strict";var appModule=angular.module("appModule",["ui.router","angular.chips","ngImgCrop","angular-carousel"]);appModule.config(["$stateProvider","$urlRouterProvider",function(e,t){e.state("home",{url:"/home",templateUrl:"views/home.html",controller:"homeCtrl"}).state("gallery",{url:"/gallery",templateUrl:"views/gallery.html",controller:"galleryCtrl"}).state("image",{url:"/image/{userId}/{imageId}",templateUrl:"views/image.html",controller:"imageCtrl"}).state("search",{url:"/search/{searchPtrn}",templateUrl:"views/search.html",controller:"searchCtrl"}).state("user",{url:"/user/{userId}",templateUrl:"views/user.html",controller:"userCtrl"}).state("registration",{url:"/registration",templateUrl:"views/registration.html",controller:"registrationCtrl"}).state("authorization",{url:"/authorization",templateUrl:"views/authorization.html",controller:"authorizationCtrl"}).state("cabinet",{url:"/cabinet",templateUrl:"views/cabinet.html",controller:"cabinetCtrl"}).state("contacts",{url:"/contacts",templateUrl:"views/contacts.html",controller:"contactsCtrl"}).state("about",{url:"/about",templateUrl:"views/about.html",controller:"aboutCtrl"}),t.otherwise("/home")}]),appModule.service("Authentification",function(e){this.currentUser={},this.authUser=function(t){firebase.auth().signInWithEmailAndPassword(t.email,t.password).then(function(t){this.currentUser.name=t.displayName,this.currentUser.id=t.uid,sessionStorage.setItem("currentUserName",this.currentUser.name),sessionStorage.setItem("currentUserId",this.currentUser.id),alert("Authentification successed. Now - cabinet"),e.go("cabinet")}.bind(this)).catch(function(e){var t=e.code,a=e.message;return"auth/invalid-email"===t?alert(a):"auth/user-disabled"===t?alert(a):"auth/user-not-found"===t?alert(a):"auth/wrong-password"===t?alert(a):void 0})},this.returnCurrentUser=function(){return this.currentUser},this.logout=function(){var t=this;firebase.auth().signOut().then(function(){sessionStorage.removeItem("currentUserName"),sessionStorage.removeItem("currentUserId"),t.currentUser.name="",alert("Sign out success"),e.go("home")}).catch(function(e){return console.log(e)})}}),appModule.service("FindImgService",function(){this.findImages=function(e){return firebase.database().ref().child("Users").once("value").then(function(t){return function(t){var a=[];for(var o in t)for(img in t[o].images)t[o].images[img].tags.some(function(t){return t==e})&&a.push(t[o].images[img]);return a}(t.val())})}}),appModule.service("Map",function(){this.init=function(){var e={lat:50.447941,lng:30.4516},t=new google.maps.Map(document.getElementById("map"),{zoom:15,center:e,styles:[{featureType:"water",elementType:"geometry.fill",stylers:[{color:"#d3d3d3"}]},{featureType:"transit",stylers:[{color:"#808080"},{visibility:"off"}]},{featureType:"road.highway",elementType:"geometry.stroke",stylers:[{visibility:"on"},{color:"#b3b3b3"}]},{featureType:"road.highway",elementType:"geometry.fill",stylers:[{color:"#ffffff"}]},{featureType:"road.local",elementType:"geometry.fill",stylers:[{visibility:"on"},{color:"#ffffff"},{weight:1.8}]},{featureType:"road.local",elementType:"geometry.stroke",stylers:[{color:"#d7d7d7"}]},{featureType:"poi",elementType:"geometry.fill",stylers:[{visibility:"on"},{color:"#ebebeb"}]},{featureType:"administrative",elementType:"geometry",stylers:[{color:"#a7a7a7"}]},{featureType:"road.arterial",elementType:"geometry.fill",stylers:[{color:"#ffffff"}]},{featureType:"road.arterial",elementType:"geometry.fill",stylers:[{color:"#ffffff"}]},{featureType:"landscape",elementType:"geometry.fill",stylers:[{visibility:"on"},{color:"#efefef"}]},{featureType:"road",elementType:"labels.text.fill",stylers:[{color:"#696969"}]},{featureType:"administrative",elementType:"labels.text.fill",stylers:[{visibility:"on"},{color:"#737373"}]},{featureType:"poi",elementType:"labels.icon",stylers:[{visibility:"off"}]},{featureType:"poi",elementType:"labels",stylers:[{visibility:"off"}]},{featureType:"road.arterial",elementType:"geometry.stroke",stylers:[{color:"#d6d6d6"}]},{featureType:"road",elementType:"labels.icon",stylers:[{visibility:"off"}]},{},{featureType:"poi",elementType:"geometry.fill",stylers:[{color:"#dadada"}]}]});new google.maps.Marker({position:e,map:t})}}),appModule.service("Sharing",function(){this.shareInFB=function(e){FB.ui({method:"share",href:e.imageUrl},function(e){return console.log(e)})}}),appModule.service("uploadPhotoService",function(){var e;this.recievePhoto=function(t){e=t},this.uploadPhotoToFirebase=function(t){var a=function(){function e(){return Math.floor(65536*(1+Math.random())).toString(16).substring(1)}return e()+e()+"-"+e()+"-"+e()+"-"+e()+"-"+e()+e()+e()}(),o=sessionStorage.getItem("currentUserId"),i=sessionStorage.getItem("currentUserName");firebase.storage().ref("images/"+o+"/"+a).put(e).then(function(e){console.log("Uploaded succsesfully");var a,r={imageUrl:e.metadata.downloadURLs[0],imageName:e.metadata.name,tags:t,owner:{ownerName:i,ownerId:o},likes:{numLikes:0}};a=r,firebase.database().ref().child("Users").child(o).child("images").push(a).then(function(e){var t;console.log("Image added to DB successfully"),t=e.key,firebase.database().ref().child("Users").child(o).child("images").child(t).child("id").set(t).then(function(e){console.log("Id set successfully")}).catch(function(e){console.log(e)})}).catch(function(e){console.log(e)})}).catch(function(e){console.log(e)})},this.setAvatar=function(e){var t;!function(e){for(var a=e.indexOf(";base64,"),o=e.substring(5,a),i=e.substr(a+8),r=atob(i),n=new ArrayBuffer(r.length),s=new Uint8Array(n),l=0;l<r.length;l++)s[l]=r.charCodeAt(l);var c=new Blob([n],{type:o});t=c}(e);var a=sessionStorage.getItem("currentUserId"),o=firebase.database().ref().child("Users");firebase.storage().ref().child("images/"+a+"/avatar/avatar").put(t).then(function(e){var t,i=e.metadata.downloadURLs[0];t={avatarUrl:i},o.child(a).update(t)}).catch(function(e){console.log(e)})}}),appModule.component("addAvatarModal",{bindings:{heading:"@",hide:"&"},template:'<div class="modal-bg" id="modal-add-avatar" ng-click="$ctrl.hide()"> \n            <div class="modal-content" ng-click="$event.stopPropagation()">\n                <div class="modal-header"> \n                    {{ $ctrl.heading }} \n                    <div class="close-modal" ng-click="$ctrl.hide()"></div>\n                </div>\n                <div class="modal-body">\n                    <div class="image-preview">\n                        <input photo-upload type="file" accept="image/*" name="newPhoto" class="upload-photo" id="upload-new-photo">\n                        <label for="upload-new-photo" class="photo-item" ng-if="!image">\n                            <img src="./images/add-image.svg">\n                        </label>\n                        <img-crop ng-if="image" image="image" area-type="square" result-image="$ctrl.myAvatar" class="photo-item"></img-crop>\n                    </div>                    \n                </div>\n                <div class="modal-controls">\n                    <input type="submit" value="Set avatar" class="btn-submit" ng-click="$ctrl.uploadPhoto(); $ctrl.hide()">\n                </div>\n            </div>\n        </div>',controller:function(e){this.$onInit=function(){this.myAvatar=""},this.uploadPhoto=function(){e.setAvatar(this.myAvatar)}}}),appModule.component("popup",{bindings:{showToast:"="},template:'<div class="popup" ng-if="$ctrl.isShowToast">\n            <div class="popup-text">\n            </div>\n       </div>',controller:function(){this.isShowToast=!0}}),appModule.component("uploadPhotoModal",{bindings:{heading:"@",hide:"&"},template:'<div class="modal-bg" id="modal-upload-photo" ng-click="$ctrl.hide()"> \n            <div class="modal-content" ng-click="$event.stopPropagation()">\n                <div class="modal-header"> \n                    {{ $ctrl.heading }} \n                    <div class="close-modal" ng-click="$ctrl.hide()"></div>\n                </div>\n                <div class="modal-body">\n                    <div class="image-preview">\n                        <input photo-upload type="file" accept="image/*" name="newPhoto" class="upload-photo" id="upload-new-photo">\n                        <label for="upload-new-photo" class="photo-item">\n                            <img ng-if="!image" src="./images/add-image.svg">\n                            <img ng-src="{{image}}" ng-class="{\'cabinet-photo\': image}">\n                        </label>\n                    </div>\n                    <div class="image-tags">\n                        <span class="chips-label">Enter tags:</span>\n                        <chips ng-model="$ctrl.tags">\n                            <chip-tmpl>\n                                <div class="default-chip">\n                                    {{chip}}\n                                    <div class="delete-chip" remove-chip>\n                                    \n                                    </div>\n                                </div>\n                            </chip-tmpl>\n                            <input chip-control></input>\n                        </chips>\n                    </div>\n                </div>\n                <div class="modal-controls">\n                    <input type="submit" value="Upload" class="btn-submit" ng-click="$ctrl.uploadPhoto(); $ctrl.hide()">\n                </div>\n            </div>\n        </div>',controller:function(e){this.$onInit=function(){this.tags=[]},this.uploadPhoto=function(){e.uploadPhotoToFirebase(this.tags)}}}),appModule.controller("aboutCtrl",["$scope",function(e){}]),appModule.controller("authorizationCtrl",["$scope","$state","Authentification",function(e,t,a){e.authUser=function(e){a.authUser(e),authForm.reset()},e.ifToastToShow=function(){e.ifToastShow=!e.ifToastShow,console.log(e.ifToastShow)}}]),appModule.controller("cabinetCtrl",["$scope","$state","$location","Authentification","Sharing",function(e,t,a,o,i){if(0!=sessionStorage.length)var r=sessionStorage.getItem("currentUserId"),n=firebase.database().ref().child("Users").child(r).child("avatarUrl"),s=firebase.database().ref().child("Users").child(r).child("images");s.on("value",function(t){e.userPhotos=Object.values(t.val()),e.userPhotos.reverse(),e.$$phase||e.$digest()}),n.on("value",function(t){e.avatar=t.val(),e.$$phase||e.$digest()}),e.deleteImage=function(e){s.child(e.id).remove(),firebase.storage().ref().child("images").child(r).child(e.imageName).delete().then(function(){console.log("Image deleted successfully")}).catch(function(e){console.log(e)})},e.goToImagePage=function(e){a.path("image/"+r+"/"+e.id)},e.hideUploadPhotoModal=function(){e.uploadPhotoModal=!1},e.showUploadPhotoModal=function(){e.uploadPhotoModal=!0},e.showAddAvatarModal=function(){e.addAvatarModal=!0},e.hideAddAvatarModal=function(){e.addAvatarModal=!1},e.toggleShareBlock=function(e){e.isShareBlockActive=!e.isShareBlockActive},e.hideOnLeave=function(e){e.isShareBlockActive=!1},e.shareFB=function(e){i.shareInFB(e)},e.logout=function(){o.logout()}}]),appModule.controller("contactsCtrl",["$scope","Map",function(e,t){t.init(),e.sendComplaint=function(e){var t=firebase.database().ref().child("Complaints"),a={userName:e.name,userEmail:e.email,subject:e.subject,message:e.messageText};t.push(a).then(function(e){complaintForm.reset(),alert("Complaint send successfully")}).catch(function(e){console.log(e)})}}]),appModule.controller("galleryCtrl",["$scope","$location","Sharing","Authentification",function(e,t,a,o){var i=firebase.database().ref().child("Users");e.allImagesArr=[],i.once("value",function(t){var a=t.val();for(var o in a){var i=a[o].images;for(var r in i)e.allImagesArr.push(i[r])}e.allImagesArr.sort(function(){return.5-Math.random()}),e.$$phase||e.$digest()}),e.setLike=function(t,a){t.isLike=!t.isLike;var o=sessionStorage.getItem("currentUserId"),i=a.owner.ownerId,r=a.id,n=firebase.database().ref().child("Users").child(i).child("images").child(r).child("likes");t.isLike?(n.child("likesBy").push(o),n.child("numLikes").once("value",function(e){var t=+e.val();++t,n.child("numLikes").set(t)})):n.child("numLikes").once("value",function(e){var t=+e.val();--t,n.child("numLikes").set(t)}),n.child("numLikes").on("value",function(t){e.likesNumber=t.val(),e.$$phase||e.$digest()})},e.goToImagePage=function(e){t.path("image/"+e.owner.ownerId+"/"+e.id)},e.toggleShareBlock=function(e){e.isShareBlockActive=!e.isShareBlockActive},e.hideOnLeave=function(e){e.isShareBlockActive=!1},e.shareFB=function(e){a.shareInFB(e)}}]),appModule.controller("homeCtrl",["$scope","Carousel",function(e,t){e.Carousel=t;var a=firebase.database().ref().child("Users");e.images=[],a.once("value").then(function(t){var a=t.val();for(var o in a){var i=a[o].images;for(var r in i)e.images.push(i[r]),e.$$phase||e.$digest()}})}]),appModule.controller("imageCtrl",["$scope","$stateParams","$location","Sharing",function(e,t,a,o){var i=firebase.database().ref().child("Users").child(t.userId).child("images").child(t.imageId),r=firebase.database().ref().child("Users").child(t.userId).child("avatarUrl");i.once("value",function(t){e.image=t.val(),console.log(e.image),e.$$phase||e.$digest()}).catch(function(e){console.log(e)}),r.once("value",function(t){e.avatar=t.val(),e.$$phase||e.$digest()}).catch(function(e){console.log(e)}),e.goToUserPage=function(e){console.log(e),a.path("user/"+e)},e.toggleShareBlock=function(){e.isShareBlockActive=!e.isShareBlockActive},e.shareFB=function(e){o.shareInFB(e)}}]),appModule.controller("registrationCtrl",["$scope","$state",function(e,t){e.addUser=function(a){firebase.auth().createUserWithEmailAndPassword(a.email,a.password).then(function(o){e.currentUser=firebase.auth().currentUser;var i,r,n,s,l=firebase.auth().currentUser.uid;e.currentUser.updateProfile({displayName:a.nickname}).then(function(){console.log("Username added successfully")}).catch(function(e){console.log("Username NOT added")}),i=l,r=a.nickname,n=firebase.database().ref().child("Users"),s={userName:r},n.child(i).set(s).then(function(e){console.log("Child added good"),regForm.reset()}).catch(function(e){console.log(e)}),alert("Register successed. Use authorization to sign in"),t.go("authorization")}).catch(function(e){var t=e.code,a=e.message;"auth/email-already-in-use"===t&&alert(a)})},e.createRetypePassRegexp=function(){e.retypePassRegexp=new RegExp("^"+e.newUser.password+"$")}}]),appModule.controller("rootController",["$scope","$location","Authentification","FindImgService",function(e,t,a,o){e.emailRegexp=/^[-\w\+\.]+@(\w+\.)+\w+$/,e.toggleBurger=function(t){e.isBurgerActive=!e.isBurgerActive,console.log(e.isBurgerActive),t.stopPropagation()},e.user={},0!=sessionStorage.length?(e.user.name=sessionStorage.getItem("currentUserName"),e.user.id=sessionStorage.getItem("currentUserId")):e.user=a.returnCurrentUser(),e.findImages=function(){var a=encodeURI(e.searchTags);t.path("/search/"+a),e.searchTags=""}}]),appModule.controller("searchCtrl",["$scope","$stateParams","$location","FindImgService","Sharing",function(e,t,a,o,i){var r=decodeURI(t.searchPtrn);o.findImages(r).then(function(t){e.searchedImages=t,e.$$phase||e.$digest()}),e.goToUserPage=function(e){a.path("user/"+e)},e.toggleShareBlock=function(){e.isShareBlockActive=!e.isShareBlockActive},e.shareFB=function(e){i.shareInFB(e)}}]),appModule.controller("userCtrl",["$scope","$stateParams","Sharing",function(e,t,a){var o=firebase.database().ref().child("Users").child(t.userId);o.child("userName").once("value",function(t){e.userName=t.val(),console.log(t.val()),e.$$phase||e.$digest()}),o.child("avatarUrl").once("value",function(t){e.avatar=t.val()}),o.child("images").once("value",function(t){e.userPhotos=Object.values(t.val()),console.log(e.userPhotos),e.$$phase||e.$digest()}),e.toggleShareBlock=function(e){e.isShareBlockActive=!e.isShareBlockActive},e.hideOnLeave=function(e){e.isShareBlockActive=!1},e.shareFB=function(e){a.shareInFB(e)}}]),appModule.directive("photoUpload",["uploadPhotoService",function(e){return{restrict:"A",link:function(t,a){a.on("change",function(o){var i,r;i=a[0].files[0],(r=new FileReader).onload=function(e){t.$apply(function(t){t.image=e.target.result})},r.readAsDataURL(i),e.recievePhoto(i)})}}}]);
//# sourceMappingURL=app.js.map
